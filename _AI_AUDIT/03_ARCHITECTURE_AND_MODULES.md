# 03_ARCHITECTURE_AND_MODULES - Ø§Ù„Ø¨Ù†ÙŠØ© ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª

## Ù…Ø§ ØªÙ… ÙØ­ØµÙ‡
- âœ… Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØµØ¯Ø±
- âœ… Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø¨ÙŠÙ† Ø§Ù„ÙˆØ­Ø¯Ø§Øª
- âœ… Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©

---

## ğŸ›ï¸ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ©

### Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ù…ØªØ¨Ø¹: **Layered Monolith + Serverless API**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Presentation Layer                â”‚
â”‚          (React Components + Tailwind)          â”‚
â”‚  - Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…           â”‚
â”‚  - RTL Arabic UI                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Business Logic Layer              â”‚
â”‚            (services/*.ts)                      â”‚
â”‚  - authService: Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©                        â”‚
â”‚  - aiService: ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±                    â”‚
â”‚  - enrichmentService: Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Data Access Layer                 â”‚
â”‚          (services/db.ts â†’ api/*.ts)           â”‚
â”‚  - db.ts: ÙˆØ§Ø¬Ù‡Ø© fetch Ù„Ù„Ù€ API                   â”‚
â”‚  - api/*: Serverless handlers                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Database Layer                    â”‚
â”‚          (PostgreSQL via Neon)                  â”‚
â”‚  - api/_db.ts: connection pool                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ ØªÙØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª (Modules)

### 1. ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth Module)

| Ø§Ù„Ù…Ù„Ù | Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© |
|-------|-----------|
| `services/authService.ts` | ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬ØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª |
| `services/rateLimitService.ts` | Ø­Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ (5/15min) |
| `components/Login.tsx` | ÙˆØ§Ø¬Ù‡Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ |
| `components/RoleGuard.tsx` | Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø¨Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª |

**Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª:**
```
authService â†’ db.ts â†’ api/users.ts
           â†’ rateLimitService
```

**Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù:**
- âš ï¸ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø«Ø§Ø¨ØªØ© `admin123`
- âš ï¸ Session ÙÙŠ localStorage (Ù„Ø§ httpOnly cookies)

---

### 2. ÙˆØ­Ø¯Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (AI Module)

| Ø§Ù„Ù…Ù„Ù | Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© |
|-------|-----------|
| `services/aiService.ts` | ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø¥ØµÙ„Ø§Ø­ JSON ØªÙ„Ù‚Ø§Ø¦ÙŠ |
| `services/geminiService.ts` | (ÙØ§Ø±Øº - Ù…ÙÙ„ØºÙ‰) |
| `constants.tsx:SECTOR_TEMPLATES` | Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª |

**Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª:**
```
aiService â†’ db.ts (getAISettings)
         â†’ authService (getCurrentUser)
         â†’ rateLimitService (Ø­Ø¯ 30/ÙŠÙˆÙ…)
         â†’ @google/genai
```

**Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**
- âœ… REPORT_SCHEMA ØµØ§Ø±Ù… (194 Ø³Ø·Ø±)
- âœ… Auto-retry Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ JSON (maxRetries=2)
- âœ… Ø¯Ø¹Ù… Gemini Ùˆ OpenAI

**Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù:**
- âš ï¸ API Key Ù‚Ø¯ ÙŠÙØ­Ù‚Ù† ÙÙŠ Frontend Ø¹Ø¨Ø± Vite

---

### 3. ÙˆØ­Ø¯Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Leads Module)

| Ø§Ù„Ù…Ù„Ù | Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© |
|-------|-----------|
| `api/leads.ts` | CRUD endpoints |
| `components/LeadForm.tsx` | Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ |
| `components/LeadList.tsx` | Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ |
| `components/LeadDetails.tsx` | ØªÙØ§ØµÙŠÙ„ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ |

**Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª:**
```
LeadForm â†’ aiService.generateReport()
        â†’ enrichmentService.enrichLead()
        â†’ db.saveLead(), db.saveReport()
```

**Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (`types.ts:105-135`):**
```typescript
interface Lead {
  id: string;
  companyName: string;
  activity: string;
  city?: string;
  website?: string;
  status: LeadStatus;
  ownerUserId: string;
  teamId: string;
  sector?: { primary: string; confidence: number };
  enrichment_signals?: EvidencePack;
  // ... 15 Ø­Ù‚Ù„ Ø¢Ø®Ø±
}
```

---

### 4. ÙˆØ­Ø¯Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Reports Module)

| Ø§Ù„Ù…Ù„Ù | Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© |
|-------|-----------|
| `api/reports.ts` | Ø­ÙØ¸/Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± |
| `components/ReportView.tsx` | Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (22KB - Ø§Ù„Ø£ÙƒØ¨Ø±) |
| `services/exportService.ts` | ØªØµØ¯ÙŠØ± PDF/CSV |

**REPORT_SCHEMA ÙŠØªØ¶Ù…Ù†:**
- `company` - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
- `sector` - Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù…ÙƒØªØ´Ù
- `evidence_summary` - Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ù„Ø©
- `website_audit` - ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
- `social_audit` - ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙˆØ´ÙŠØ§Ù„
- `pain_points` - Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ù„Ù…
- `quick_wins` - Ù…ÙƒØ§Ø³Ø¨ Ø³Ø±ÙŠØ¹Ø©
- `recommended_services` - Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§
- `talk_track` - Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
- `follow_up_plan` - Ø®Ø·Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©

---

### 5. ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Settings Module)

| Ø§Ù„Ù…Ù„Ù | Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© |
|-------|-----------|
| `api/settings.ts` | AI/Scoring settings API |
| `components/SettingsPanel.tsx` | ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© |
| `services/whatsappService.ts` | Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª WhatsApp |
| `services/encryptionService.ts` | "ØªØ´ÙÙŠØ±" API Keys |

**Ø§Ù„ØªØ¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:**
1. AI Settings (Gemini/OpenAI keys, temperature, prompt)
2. WhatsApp Integration (API URL, key, sender ID)
3. Google Sheets (Sheet ID, tab name)
4. Scoring Settings (Ù†Ù‚Ø§Ø· Ù„ÙƒÙ„ Ù†Ø´Ø§Ø·)
5. Audit Logs (Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª)

---

## ğŸ”— Ù…Ø®Ø·Ø· Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª (Dependency Graph)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   App.tsx    â”‚
                    â”‚   (Router)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼          â–¼       â–¼       â–¼          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚Login   â”‚ â”‚Dashboardâ”‚ â”‚LeadFormâ”‚ â”‚Settingsâ”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚           â”‚         â”‚          â”‚
       â–¼           â–¼         â–¼          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚              services/                   â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚authSvc  â”‚ â”‚ aiSvc    â”‚ â”‚ dbSvc    â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
   â”‚       â”‚           â”‚            â”‚        â”‚
   â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”‚        â”‚
   â”‚  â”‚rateLim  â”‚ â”‚enrichSvcâ”‚       â”‚        â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚   api/*.ts   â”‚
                            â”‚   (fetch)    â”‚
                            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ PostgreSQL   â”‚
                            â”‚   (Neon)     â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”´ Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ´Ø§Ø¨Ùƒ Ø§Ù„Ø­Ø³Ø§Ø³Ø© (Coupling Points)

| Ø§Ù„Ù†Ù‚Ø·Ø© | Ø§Ù„Ù…Ø´ÙƒÙ„Ø© | Ø§Ù„ØªØ£Ø«ÙŠØ± |
|--------|---------|---------|
| `db.ts` | ÙƒÙ„ Services ØªØ¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡ | Ù†Ù‚Ø·Ø© ÙØ´Ù„ ÙˆØ§Ø­Ø¯Ø© |
| `authService` | localStorage global state | ØµØ¹ÙˆØ¨Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± |
| `aiService` | ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ 4 services Ø£Ø®Ø±Ù‰ | ØªØ¹Ù‚ÙŠØ¯ debugging |
| `types.ts` | 200 Ø³Ø·Ø± interfaces Ù…Ø´ØªØ±ÙƒØ© | ØªØºÙŠÙŠØ± ÙˆØ§Ø­Ø¯ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„ |
| `constants.tsx` | Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙˆØ§Ù„Ø¨Ø§Ù‚Ø§Øª | ØªØ­ØªØ§Ø¬ DB migration Ù„Ù„ØªØ­Ø¯ÙŠØ« |

---

## ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒÙˆØ¯

| Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ | Ø§Ù„Ù‚ÙŠÙ…Ø© |
|---------|--------|
| Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ù„ÙØ§Øª TypeScript | ~35 Ù…Ù„Ù |
| Ø£ÙƒØ¨Ø± Ù…Ù„Ù | `components/SettingsPanel.tsx` (379 Ø³Ø·Ø±) |
| Ø£ÙƒØ¨Ø± Schema | `aiService.ts REPORT_SCHEMA` (~185 Ø³Ø·Ø±) |
| Ø¹Ø¯Ø¯ Ø§Ù„Ù€ Interfaces | 18 interface ÙÙŠ `types.ts` |
| Ø¹Ø¯Ø¯ Ø§Ù„Ù€ Enums | 4 (UserRole, LeadStatus, RateLimitAction, SectorSlug) |
