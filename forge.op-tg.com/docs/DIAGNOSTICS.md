# صفحة التشخيصات — للمشرف

تعرض صفحة التشخيصات ملخصًا سريعًا للحالة التشغيلية وتساعدك على متابعة الوحدات الطرفية والوظائف ودفعات الأماكن، بشكل قراءة فقط.

## الوصول

- من القائمة الجانبية: التشخيصات
- المسار: /admin/diagnostics/index.php (GET)

## ملخص الإعدادات

- يعرض قيمًا عامة للقراءة فقط (دون أسرار)، مثل مزود الأماكن ونظام الطابور وبعض حدود المعدلات.

## صحة الوحدات الطرفية

- يظهر آخر ظهور لكل عامل وحالته (متصل/غير متصل) والمضيف والإصدار والمهمة الحالية إن وجدت.
- يعتبر العامل “متصلًا” إذا تم رصده خلال آخر دقيقتين.
 - صفحة «العامل — بث مباشر»: admin/worker_live.php
	 - تستخدم SSE عبر /api/worker_stream.php مع استطلاع احتياطي عبر /api/worker_status.php.
	 - مؤشرات على الصفحة:
		 - «آخر تقرير»: شارة OK/متأخر/متوقف مبنية على report_every_ms.
		 - «انتهاء التأجير»: عدّاد تنازلي للـ lease_expires_at إن وُجدت مهمة نشطة.
	 - إن لم يعمل SSE بسبب الشبكة، ستتحول الصفحة تلقائيًا إلى الاستطلاع كل 5 ثوانٍ.

## الوظائف الحديثة

- جدول لأحدث الوظائف مع إمكانية التصفية حسب الحالة: الكل، قيد الانتظار، قيد المعالجة، منتهية، فاشلة (failed).
- يعرض أوقات الإنشاء/التحديث/الانتهاء ومقتطف الخطأ عند وجوده.
- أزرار مختصرة لكل صف: Requeue، +دقائق (تمديد الحجز)، إنهاء، إلغاء — جميعها محمية بـ CSRF.
- عدّادات أعلى الجدول: منتظرة، جارية، منتهية الحجز، منتهية.
- تصدير CSV لنفس الفلاتر الحالية عبر: admin/internal_export.php (GET) بتمرير نفس Query String.

## دفعات الأماكن (قراءة فقط)

- ملخص لأحدث الدُفعات بحسب batch_id ويتيح تصدير CSV للدُفعات الصغيرة مباشرة من الواجهة (محمي CSRF).
- الأعمدة: place_id, name, phone, address, lat, lng, website, types_json, source, source_url, collected_at, last_seen_at, batch_id
- ملاحظة: الدُفعات الكبيرة (أكثر من 50,000 صف) ستُعالج لاحقًا عبر CLI (TODO).

## ملاحظات
- لا تغييرات على المسارات أو التسميات القائمة.
- الصفحة للقراءة فقط ومحصورة بالمشرف، وجميع النماذج محمية بـ CSRF.

## أدوات تشخيصية (CLI)

- tools/ops/probe_heartbeat.php — يتأكد من /api/heartbeat.php مع الرؤوس الصحيحة (يدعم السر القديم وHMAC)
- tools/diag/probe_pull_job.php — يتأكد من /api/pull_job.php ويعرض كود الحالة ونص الرد لسهولة التشخيص
	- إن عاد 429 مع {error: cb_open} فهذا يعني أن القاطع مفتوح للعامل. أغلق القاطع من صفحة العمال.

اعتبارات:
- الأدوات للاستخدام المحلي لغرض الفحص، لا تطبع الأسرار.

## دليل تشخيص الخرائط (Leaflet Troubleshooting)

استخدم هذه القائمة عند اختفاء الخريطة أو تعذّر تحميل البلاطات:

1) تحقق من توفر مكتبة Leaflet:
	- في المتصفح: افتح Console واكتب `!!window.L` — يجب أن تكون `true`.
	- إن كانت `false`: تحقق من `<head>` في الصفحة (layout_header.php) وتأكد من تحميل `assets/vendor/leaflet/leaflet.js` محليًا.

2) تحقق من CSS:
	- افحص في Network: هل تم تحميل `leaflet.css`؟
	- إن لم يُحمّل: ستمنع قواعد `img{max-width:100%}` البلاطات من الظهور؛ تأكد من وجود قواعد الحماية في `assets/css/style.css`.

3) مصادر البلاطات (Tile Sources):
	- انظر السطر أسفل الخريطة: يظهر المصدر الحالي والتنقل بين البدائل.
	- إن كانت المصادر محجوبة، قم بضبط `tile_sources_json` في صفحة الإعدادات بقيم مسموح بها داخل الشبكة.
	- مثال عنصر: `{ "url": "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", "att": "© OpenStreetMap contributors" }`

4) فحص الشبكة:
	- استخدم أدوات المطور → Network للتحقق من أخطاء CORS/403/timeout على نطاقات البلاطات.
	- إن لزم، اطلب من الشبكة المؤسسية فتح النطاقات المطلوبة أو توفير مصدر داخلي.

5) التحقق النهائي:
	- بعد التعديل، أعد تحميل الصفحة وتأكد من ظهور رسالة "تم التحميل من المصدر …".
	- كبس الخريطة والسحب يجب أن يعملان دون أخطاء.
- في حال فشل الطلب مع 401/403/500 راجع الإعدادات: internal_server_enabled، internal_secret، وتأكد من تزامن الوقت.
