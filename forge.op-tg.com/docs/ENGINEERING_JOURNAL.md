# السجل الهندسي للمشروع (Engineering Journal)

الغرض من هذا الملف توفير سرد شامل ومحدّث لتاريخ تطوير النظام، أهم التغييرات، المشكلات التي واجهتنا وكيف حللناها، والدروس المستفادة. هذا السجل موجّه لأي مطوّر جديد أو عضو فريق يحتاج لفهم الصورة الكبيرة بسرعة.

## نظرة عامة سريعة على البنية
- الواجهة الخلفية: PHP 8.x + SQLite (ملف `storage/app.sqlite`، ترحيلات idempotent في `config/db.php`).
- الواجهة الأمامية: jQuery + DataTables (+Responsive) + Leaflet 1.9.4 + FontAwesome + خط Tajawal.
- المعالجة والصف: نظام داخلي لإدارة الوظائف Internal Jobs مع مفاهيم: lease, attempts, progress, stuck detection، مراقبة حيّة (SSE) وصفحات إدارة.
- المزايا البارزة: ميزات إمكانية الوصول، الوضع الداكن، حفظ تفضيلات الفلاتر، إدارة أعمدة الجداول وكثافتها، أقسام collapsible للبيانات التفصيلية، أدوات تشخيص.

راجع المستندات:
- SYSTEM_OVERVIEW.md — نظرة شاملة على النظام.
- RUNBOOK.md / WORKER_RUNBOOK.md — التشغيل اليومي وإدارة الوحدات الطرفية.
- UPDATE_FLOW.md — تدفق التحديث والإصدارات.
- DIAGNOSTICS.md — التشخيص واستكشاف الأعطال.

## الخط الزمني للأعمال (مختصر)
- الاستقرار الأولي:
  - تثبيت مراقبة العمال والوضع الحيّ، قفل/إفراج آمن للوظائف، كشف العالقين، وأدوات الإدارة لإعادة الطابور/الإلغاء.
  - اختبارات smoke خضراء.
- تحديثات تجربة المستخدم:
  - توحيد الشكل العام (فاتح/داكن)، تحسين التباين، الخطوط، focus-visible، ripple، كثافة الجداول (Compact)، رؤوس ثابتة.
  - DataTables: مدير أعمدة مع Presets وحفظ تفضيلات المستخدم.
  - تحسينات الجوال: صفحة دخول نحيفة، قوائم جانبية متوافقة، RTL، Drawer.
- موجة تحسينات 1.5:
  - خط Tajawal عربي، meta theme-color، زر العودة للأعلى، تحسين ARIA، مزامنة إعداد السمة مع تفضيل النظام، حالات Empty State.
  - نقل البيانات التفصيلية إلى أقسام قابلة للطيّ مع كتل كود وأزرار نسخ.
  - حفظ فلاتر الواجهات (feature flag: ui_persist_filters).
- معالجة عطب الخرائط (Leaflet):
  - الأعراض: اختفاء الخرائط في صفحات fetch (الإدارة/المندوب).
  - الأسباب المحتملة: ترتيب تحميل Leaflet، حجب CDN لمكتبات/أنماط Leaflet، أثر قواعد CSS responsive على صور البلاطات، وحجب مصادر البلاطات نفسها.
  - الحل: انظر قسم «الحوادث» بالتفصيل وروابط ADR أدناه.

## أهم التغييرات الفنية
- Leaflet: اعتماد نسخة محليّة (assets/vendor/leaflet/*) مع سلسلة بدائل CDN، وتحميل متزامن في صفحات fetch لمنع السباقات.
- طبقة البلاطات: طبقة مرنة مع مصادر متعددة وفواصل تلقائية عند فشل المصدر، مع سطر حالة يُظهِر مصدر التحميل.
- CSS: إبطال قواعد max-width داخل حاوية Leaflet لمنع انهيار البلاطات عند غياب CSS الخاص بالمكتبة.
- الإعدادات: إضافة tile_sources_json (اختياري) لتهيئة مصادر البلاطات عبر لوحة الإدارة.
- الأمان: رؤوس non-breaking (nosniff/referrer-policy/HSTS)، وCSP تقرير فقط لتجنب كسر الوظائف أثناء الانتقال.
- قابلية الاستخدام: حفظ تفضيلات الفلاتر وعدادات الكثافة محليًا لكل صفحة/جدول عبر localStorage.
 - واجهة العامل الحيّة: نقل من JavaScript مضمن إلى `status.js` خارجي مع رأس `Cache-Control: no-store`، اشتراك SSE (events/logs) مع keep-alive وFallback استطلاع. SSR inject `window.__statusSSR` لتقديم أولي سريع وثابت حتى عند حجب JS.
 - قاطع لكل عامل: واجهة إدارة لفتح/إغلاق القاطع تضبط `cb_open_workers_json`؛ طبقة API تعيد 429 `cb_open` في `pull_job` لمنع المهام الجديدة فقط، مع إبقاء الاتصال والنبض.
 - إصلاح DataTables: مواءمة عدد الأعمدة في admin/workers.php لإزالة تحذيرات "Incorrect column count".

## التحسينات الأمنية والقابلية للتشغيل
- حماية جلسات الدخول (SameSite=Strict، HttpOnly، Secure عند HTTPS).
- CSRF: تحقق اختياري تلقائي لطلبات النماذج (feature flag security_csrf_auto).
- معدّلات الطلبات: حد بسيط اختياري (rate_limit_basic) + counters يومية.
- مراقبة العمال: last_seen، نافذة اعتبار «متصل»، تنظيف السجلات القديمة.

## الدروس المستفادة
- مكتبات حرجة (Leaflet) يجب توفرها محليًا مع بدائل CDN؛ لا تعتمد على CDN فقط.
- يجب حماية الودجات الخارجية من قواعد CSS العامة (مثل صور Leaflet مقابل img{max-width:100%}).
- قدم فواصل ومرونة على مصدر البيانات الخارجي (مصادر البلاطات)، وأظهر التشخيص للمستخدم.
- اجعل الميزات التي تغيّر سلوك الواجهة محكومة بعَلم (feature flag) وقابلة للقياس/الإطفاء.
 - عند استخدام SSE، وفّر دائمًا استطلاعًا احتياطيًا وتحقق من رؤوس no-store لمنع التخزين الوسيط.
 - لا تجعل إجراءات التحكم (Pause/Arm/Disarm) تغيّر حالة الاتصال ظاهريًا إذا كانت لا تؤثر على القناة فعليًا؛ افصل بين "متصل" و"موقوف" لتجنّب ارتباك المشغّل.

## روابط ومرجع
- INCIDENTS.md — حوادث موثقة، بما فيها حادثة الخرائط (أكتوبر 2025).
- ARCH_DECISIONS.md — قرارات معمارية (ADRs) مثل Local-first Leaflet وtile_sources_json.
- GEODATA_SOURCES.md — مصادر جغرافية واعتبارات الترخيص.
- CHANGELOG.md — تغييرات إصدارات عالية المستوى.
