# سجل الحوادث والتعامل معها (Incidents)

هذا الملف يوثّق الحوادث التقنية الهامّة، الأعراض، أسباب الجذور، وخطط المعالجة والوقاية مستقبلًا.

## 2025-10 — تعطل عرض الخرائط في صفحات الجلب
- النطاق: صفحات `admin/fetch.php` و`agent/fetch.php`.
- الأعراض: اختفاء الخريطة أو مساحة فارغة؛ لا تُعرض البلاطات.
- سياق: تغييرات على رأس الصفحة والأساليب، وتحديثات شاملة على الواجهة.

### الفرضيات الأولية
1) ترتيب تحميل Leaflet: تنفيذ سكريبت التهيئة قبل توفر `window.L`.
2) حجب CDN: فشل تحميل `leaflet.css/js` بسبب سياسات الشبكة أو انقطاع خارجي.
3) أثر CSS عام: قاعدة `img{max-width:100%}` تسببت بانهيار أبعاد البلاطات عند غياب CSS الخاص بـ Leaflet.
4) حجب مصادر البلاطات نفسها (tile.openstreetmap.org وغيرها).

### الإجراءات التصحيحية
- التحميل المحلي أولًا لمكتبة Leaflet (assets/vendor/leaflet/*) مع سلاسل بدائل لـ unpkg/jsDelivr عند الضرورة.
- جعل تحميل Leaflet متزامنًا في صفحات fetch أو تأجيل التهيئة حتى يتحقق وجود `window.L` مع محاولة تلقائية لإعادة الحقن عند الفشل.
- إضافة حماية CSS:
  - `.leaflet-container img{max-width:none!important;height:auto}`
  - `.leaflet-container .leaflet-tile{max-width:none!important}`
  - `.leaflet-marker-icon,.leaflet-marker-shadow{max-width:none!important}`
  - `.leaflet-tile{width:256px;height:256px}`
- طبقة بلاطات مرنة مع مصادر متعددة وفواصل تلقائية عند فشل البلاطات، وإظهار سطر حالة أسفل الخريطة يبيّن المصدر الحالي.
- واجهة إعدادات إدارية `tile_sources_json` لتهيئة مصادر البلاطات الموافق عليها ضمن المؤسسة.

### النتائج
- استُعيد عرض الخرائط بغض النظر عن توفر CDN، مع قدرة على العمل ضمن بيئات مغلقة عبر المصادر المسموح بها.
- تحسّن قابلية التشخيص: السطر أسفل الخريطة يعرض المصدر ويشير لعمليات الانتقال بين البدائل.

### الوقاية والمتابعة
- الاستمرار على نهج local-first للمكتبات الحرجة.
- مراجعة دورية لقواعد CSS العامة وتأثيرها على الودجات الخارجية.
- توفير مصدر بلاطات داخلي أو CDN مؤسسي إن لزم.

### التفاصيل الفنية الموسّعة (Incident Report Full)

- معرف الحادث: MAP-2025-10
- التاريخ/الوقت (تقريبي): 2025-10-11 09:00Z — رُصد من قبل المستخدم النهائي (عميل داخلي)
- التأثير: تعذّر تحديد المواقع يدويًا في نماذج الجلب (تأثير مباشر على إنشاء المهام)
- الشدة: مرتفع (P1) — تعطيل مسار أساسي

#### خط الزمن (Timeline)
- T0: ظهور المشكلة — صفحات fetch لا تعرض خريطة (بدون أخطاء ظاهرة للمستخدم)
- T0+1h: تحقيق أولي — التحقق من عناصر DOM وأسلوب التحميل؛ رصد احتمال سباقات تحميل Leaflet
- T0+4h: إضافة حماية CSS وإعادة ترتيب التحميل؛ تحسن متقطع حسب البيئة
- T0+6h: إضافة تحميل محلي لملفات Leaflet وسلسلة fallback ديناميكي (local → unpkg → jsDelivr)
- T0+8h: إضافة طبقة بلاطات مرنة مع سطر حالة تشخيصي وفواصل تلقائية على الأخطاء
- T0+24h: التحقق في بيئات متعددة؛ إضافة إعداد tile_sources_json للسماح بمصدر داخلي/مؤسسي

#### سبب الجذر (Root Cause)
- متعدد العوامل:
  1) سباق التحميل (race) أدى لتنفيذ التهيئة قبل توفر `window.L` في بعض الحالات.
  2) حجب شبكي لموارد CDN (leaflet.css/js) في بعض البيئات.
  3) قواعد CSS عامة (img max-width) تسببت بانهيار البلاطات عند غياب CSS الأصلي.
  4) حجب لمصدر البلاطات الافتراضي (tile.openstreetmap.org) لدى بعض مزودي الإنترنت/الشبكات المؤسسية.

#### نطاق التغيير (Change Set)
- layout_header.php: تفضيل تحميل Leaflet محليًا على صفحات fetch، مع fallback إلى CDN.
- admin/agent/fetch.php: تهيئة مرنة للخرائط مع انتظار `window.L`، طبقة بلاطات متعددة المصادر، سطر حالة.
- assets/css/style.css: قواعد حماية Leaflet ضد تأثير img max-width.
- admin/settings.php: حقل جديد tile_sources_json (اختياري) لتحديد مصادر البلاطات الموافق عليها.

#### التحقق (Verification)
- إضافة سطر حالة تحت الخريطة: يعرض مصدر البلاطات الحالي وينبه عند الانتقال لمصدر بديل.
- فحص كونسول المتصفح: تحذيرات/أخطاء التحميل تُظهر النطاق المحجوب.
- اختبار في شبكة مغلقة: وضع نسخ Leaflet محليًا والتحقق من التحميل بدون أي اتصال خارجي.

#### أدلة الرجوع (Evidence)
- نسخة Leaflet 1.9.4 محليًا تحت `assets/vendor/leaflet/` مع الصور الافتراضية.
- إعداد tile_sources_json موثق في `docs/CONFIG_REFERENCE.md` وواجهة الإعدادات.

#### إجراءات وقائية (Preventive)
- اعتماد Local-first للمكتبات الحرجة كسياسة دائمة.
- إضافة فحوصات Smoke Test للخرائط في RUNBOOK.
- إدراج دليل تشخيص الخرائط في DIAGNOSTICS.

#### عناصر العمل (Action Items)
- [ ] توفير مصدر بلاطات داخلي/مؤسسي عند الطلب.
- [ ] توسيع صفحة التشخيصات لعرض نتيجة probe بسيطة لمصادر البلاطات.
- [ ] التقاط قياسات زمن التحميل للخرائط وLog للأخطاء الشائعة بهدف التحسين المستمر.

#### الكشف (Detection)
- بلّغ مستخدم داخلي عن اختفاء الخرائط في واجهات الجلب. تمّ تأكيد المشكلة عبر فحص سريع في أدوات المطور (Network/Console) حيث لوحظ فشل تحميل أصول Leaflet من CDN في بيئة معيّنة، وظهور صور بلاطات بأبعاد 0×0 عند غياب CSS.
- لم تكن هناك تنبيهات آلية وقتها؛ تمّت إضافة فحوص Smoke إلى RUNBOOK، مع توصية بإضافة Probe مصادر البلاطات داخل التشخيصات.

#### الأثر على العملاء (Customer Impact)
- تعذّر تحديد المواقع يدويًا عند إنشاء المهام من قبل المشرفين/المندوبين، مما عطّل جزءًا من التدفق التشغيلي (P1).
- لم تتأثر خدمات السحب الآلي أو طوابير المعالجة الخلفية.

#### ما الذي نجح (What Went Well)
- التعافي السريع بعد تبنّي نهج local-first + fallbacks.
- تحسين إمكانية التشخيص عبر سطر الحالة أسفل الخريطة وتتبع تبديل مصادر البلاطات.
- توثيق شامل: INCIDENTS, ADRs, DIAGNOSTICS, RUNBOOK، مع ربط متقاطع واضح.

#### ما الذي لم ينجح (What Didn’t)
- الاعتماد على CDN فقط لملفّات حرجة مثل Leaflet.
- غياب حماية CSS مسبقة داخل حاوية Leaflet ضد قواعد img العامة.
- عدم وجود Probe جاهز لمصادر البلاطات ضمن التشخيصات.

#### متابعة وتنفيذ (Owners • Due Dates • Status)
- [ ] UI Probe لمصادر البلاطات في التشخيصات — Owner: Web • Due: 2025-10-20 • Status: Pending
- [ ] دراسة/إعداد مصدر بلاطات داخلي (Proxy/Self-hosted) — Owner: Infra • Due: 2025-11-05 • Status: Planned
- [ ] تشغيل security_csrf_auto=1 في الإنتاج للصفحات الحساسة — Owner: Backend • Due: 2025-10-25 • Status: Planned
- [ ] توسيع أدلة الأدلة (Evidence) لتشمل لقطات خريطة + سجلات fallback — Owner: Ops • Due: 2025-10-15 • Status: In progress

روابط ذات صلة
- انظر: docs/ARCH_DECISIONS.md (ADR-001, ADR-002, ADR-003)
- انظر: docs/DIAGNOSTICS.md (Leaflet Troubleshooting)
- انظر: docs/RUNBOOK.md (Map Smoke Test)
- انظر: docs/CONFIG_REFERENCE.md (tile_sources_json)

## 2025-10 — ضبط وإيضاح CSRF/المعدلات
- ضبط أعلام الميزات: security_csrf_auto, rate_limit_basic (افتراضيًا مغلق) وإمكانية التفعيل التدريجي.
- إضافة سجلات تدقيق خفيفة لصفحة الإعدادات، وحدود نافذة «متصل» للعمال.
