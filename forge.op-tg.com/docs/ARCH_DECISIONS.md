# قرارات معمارية (ADRs)

توثيق القرارات المعمارية الهامة مع دوافعها، البدائل المدروسة، والآثار.

## ADR-001: Local-first لِـ Leaflet مع سلاسل بدائل CDN
- القرار: وضع نسخة محليّة من Leaflet (JS/CSS) تحت `assets/vendor/leaflet/` واستخدامها افتراضيًا على صفحات الخرائط. عند غيابها تُستخدم CDN مع fallback تلقائي.
- الدافع: تجنّب أعطال الشبكة/سياسات الحجب التي تمنع التحميل من CDN.
- بدائل: الاكتفاء بـ CDN، التحميل الديناميكي فقط. رُفضت لعدم الاعتمادية.
- الآثار: زيادة طفيفة في حجم المستودع؛ لكن موثوقية أعلى. يلزم تحديث النسخة المحليّة عند الترقية.

## ADR-002: طبقة بلاطات متعددة المصادر + tile_sources_json
- القرار: اعتماد طبقة بلاطات مرنة تقفز بين مصادر متعددة عند فشل التحميل، مع إمكانية تخصيص المصادر عبر إعداد `tile_sources_json`.
- الدافع: بعض البيئات تحجب نطاقات معيّنة (مثل tile.openstreetmap.org)، أو يحدث انقطاع مؤقّت.
- بدائل: مصدر واحد ثابت. رُفض لعدم الاعتمادية.
- الآثار: كود تهيئة أعقد قليلًا؛ لكن تجربة أكثر ثباتًا وقابلية تشخيص أعلى.

## ADR-003: حماية CSS لِـ Leaflet
- القرار: إضافة قواعد CSS محلية تعزل Leaflet عن قواعد `img{max-width:100%}` العامة وتضمن أبعاد البلاطات عند غياب CSS الأصلي.
- الدافع: انهيار البلاطات عند فقدان `leaflet.css` أو عند تأثير قواعد خارجية.
- الآثار: لا تغيير بصري عند وجود CSS الأصلي؛ حماية عند غيابه.

## ADR-004: أعلام ميزات لخيارات UX
- القرار: تفعيل ميزات الواجهة (مثل `ui_persist_filters`) كأعلام قابلة للتشغيل/الإطفاء، وتعرّض قيمها إلى الواجهة عبر window.__uiPersistFilters.
- الدافع: تمكين التجريب الآمن والتدرّج في الإطلاق.
- الآثار: مسار كود إضافي صغير، لكن مرونة أعلى في الإدارة.

## ADR-005: سياسة رؤوس أمان غير كاسرة + CSP تقرير فقط
- القرار: إرسال رؤوس مثل nosniff/referrer-policy/HSTS دائمًا، واستخدام CSP في وضع "report-only".
- الدافع: رفع أمان الأساس دون كسر اعتماديات خارجية أثناء الانتقال.
- الآثار: لا كسر وظيفي؛ أساس جيّد للتشدّد لاحقًا.
